* Action Items
** Rewrite 2025
*** commit =230801d= was when old JS code was removed
*** commit =3263ae7= was last Rust commit
*** TODO pending page sort order has no default selection, shows an empty button
**** maybe related to the useLocalStorage() hook
*** TODO GraphQL resolvers should log operations and abbreviated set of arguments
**** currently only getting lines like =POST /graphql 200 22.297 ms - 1356= which means nothing
*** TODO the =max-width: 300%;= hack on the query input field needs a better solution
**** TODO replace the use of ~level~ with a simple flex row
*** TODO store various selections in local storage [18/19]
- [X] (recent) page size
- [X] recent selected page
- [X] recent selected range
- [X] recent sort field/order
- [ ] browse parameters
- [X] edit query
- [X] edit sort order
- [X] edit selected page
- [X] (home) page size
- [X] home selected tags
- [X] home selected locations
- [X] home selected year
- [X] home selected season
- [X] home selected type
- [X] home selected page
- [X] home sort order
- [X] search query
- [X] search sort order
- [X] search selected page
*** TODO ~Replace~ button on details page [0/4]
- [ ] fetch existing record
- [ ] merge with new asset details
- [ ] store new record, delete old one
- [ ] use case invokes blob repo ~store~ and ~delete~ (no ~rename~ or ~replace~)
*** TODO asset browsing with left/right buttons
**** TODO browse page
**** TODO search page
**** would be neat if the buttons appeared over the image on hover, like a carousel
**** c.f. https://buefy.org/documentation/carousel
*** TODO check browser console for issues
*** TODO saving changes to pending assets sometimes does not refresh
**** updates are successful, the page is not caching
**** database view is stale, seems to need to be queried twice
**** tried =stable=false&update=true= explicitly, no change
**** tried running query at the end of =putAsset()=, no change
*** TODO changing light/dark in System Preferences does not cause page theme to change
*** TODO fix the cross-origin errors in the browser console
*** TODO document the supported date-time formats in query (anything JavaScript can parse)
*** TODO improve =jsdoc= documentation [0/2]
- [ ] associate ~global~ functions as belonging to certain source files
- [ ] fill in the huge gaping hole in the ~Home~ page
** Help
*** write help pages for each of the main pages
**** location string parsing
- format is ~label~ ; ~city~ , ~region~
- semicolon separates label from city and region
- comma separates city from region
- without separators, value is treated as ~label~ only
- example label only: garden
- example label only: London
- example label only: England
- example label + city: garden; London
- example label + city + region: garden; London, England
- example city + region: London, England
- too many semicolons or commas result in a label-only value
**** advanced query support
***** operations can be grouped with parentheses
***** supported operations of the form =predicate:value=
****** some predicate support multiple arguments separated by colon
****** possible to have an empty argument (trailing only for now), as in =loc:label:=
| name     | example               | description                    |
|----------+-----------------------+--------------------------------|
| is       | is:image              | match on the media ~type~      |
| filename | filename:img_1234.jpg | match on exact filename        |
| format   | format:jpeg           | match on the media ~subtype~   |
| tag      | tag:cats              | match on a tag                 |
| loc      | loc:paris             | match on any location field    |
| loc      | loc:any:nice          | match on any location field    |
| loc      | loc:label:beach       | match on location label field  |
| loc      | loc:city:paris        | match on location city field   |
| loc      | loc:region:france     | match on location region field |
| before   | before:2017-05-13     | match before a given date      |
| after    | after:2017-05-13      | match after a given date       |
| -        | -format:jpeg          | inverse of next operation      |
| or       | tag:cat or tag:dog    | boolean or operator            |
| and      | tag:cat and tag:dog   | boolean and operator           |
***** predicate values can be enclosed in single or double quotes
***** character escapes within quoted strings will be evaluated
***** dates are RFC 3339 formatted (https://datatracker.ietf.org/doc/html/rfc3339)
***** dates can be year (~2010~), year and month (~2010-05~), or full (~2010-05-13~)
**** pending page
- query always looks for assets without tags, caption, and location label (all 3 are missing)
**** details page
- replacing the asset with the exact same file content will have no effect, even if a different file name
- replacing an asset will change the asset identifier, media type, file name, etc
- n.b. QuickTime Player can export an AVI as MOV; be sure to rename the file to .mp4 for Chrome
- n.b. when converting videos, make sure quality and frame rate are as good as the original
**** edit page
- search is always case insensitive
- supports advanced query strings
- entering ~nihil~ in a location field will clear that field
**** search page
- search is always case insensitive
- supports advanced query strings
**** uploads page
- asset importer ignores hidden files and directories
** Pending
*** display modes: have an option that makes the images really big (single column, huge images)
*** hovering over asset should show larger version in a large tooltip
** Home
*** hover button: download raw asset
**** https://dev.to/sanchithasr/how-to-overlay-icons-on-top-of-images-with-css-1kb9
**** https://stackoverflow.com/questions/56640043/make-a-button-appear-when-hover-over-a-image
**** https://www.w3schools.com/howto/howto_css_image_overlay_icon.asp
**** https://codepen.io/veronicadev/pen/WJyOwG
**** https://www.tutorialspoint.com/how-to-create-image-overlay-icon-effect-on-hover-with-css
*** adaptive photo layout with flexbox: https://css-tricks.com/adaptive-photo-layout-with-flexbox/
*** image cards wrapped to window: https://codepen.io/jwjcmw/pen/GMQMPW
*** make the selectors row sticky when scrolling
**** allow =nav= element to scroll away
**** container with selectors and container with tags should be sticky
**** this is difficult because Bulma assumes =is-fixed-top= is for a =nav= at the top
**** trying to squeeze everything into =nav= forces all of the elements onto one row
*** when multiple attributes are selected, add a ~clear all~ button/tag
*** filter years in ~Year~ selector when there are results available
**** that is, find all possible years available among the results, only show those
*** hovering over asset should fetch and display details in a large tooltip
*** display modes
**** grid of 300x300 images with caption info (date, location/filename) (a la PhotoPrism)
**** wide blocks with thumbnails on left, more details on right (c.f. anilist.co)
**** responsive grid; images only, scaled to fit in a row and fill horizontally (i.e. ~mujina~)
***** produce thumbnails of a certain height, width is 'auto'
***** use flex display row wrap
#+begin_src html
      <div style={{
        display: 'flex',
        flexFlow: 'row wrap',
        justifyContent: 'space-around',
        alignItems: 'center'
      }}
#+end_src
**** grid of just images, maybe 180x180; images cropped to the square (a la Apple Photos)
**** list of rows, tiny thumbnail (96x96), caption, location, date
*** navigation rail for filtering assets
**** Nextcloud has a side bar for photos with these options:
***** Photos
***** Videos
***** Albums
***** People
***** Favorites
***** On this day
***** Tags
***** Locations
*** view by ~days~ like Photos.app
**** need a query that groups photos by day
*** calendar view for browsing by months
**** PhotoPrism has a ~calendar~ view that shows months of years in descending order with a random thumbnail
**** clicking on the month opens an "album" of everything in that month
** Details
*** completion for tags (like bulk edit form)
*** completion for location fields (like bulk edit form)
*** add ~copy~ button next to asset path
*** Read timezone info from Exif tags when displaying asset details
**** everything is assuming that the date/time is UTC, which is almost always wrong
**** Exif field is named =OffsetTimeOriginal= in ~primary~
**** frontend should use ~timezone~ value (if available) to show correct time in asset details
*** Format byte size using locale-specific number formatting
*** Show tiny map of where photo was taken
**** [[https://cloud.google.com/maps-platform/][Google Maps]]
- customer uses their own API key, sets in preferences
- for =testing= account: =AIzaSyAI73udKC3KVk6aIBqOjSqSv6PEQ0qd638=
**** [[https://mariusandra.github.io/pigeon-maps/][Pigeon Maps]]
- Uses data from OpenStreetMap, Wikimedia for the tiles
*** Find out if we can read GPS coordinates from videos
**** Preview.app will display location information for videos
*** Show additional file metadata (TIFF, EXIF, JFIF, IPTC)
**** use =details= and =summary= HTML tags to create expandable sections
** Uploads
*** some times temporary files are left behind in =uploads= folder
**** they are all 10,430,846 bytes long
*** make the uploads form super fancy like https://github.com/Swappea/solid-file-upload
*** theoretically could show the thumbnail of images before uploading
**** c.f. https://developer.mozilla.org/en-US/docs/Web/API/File_API/Using_files_from_web_applications
** Edit
*** hover over asset thumbnail will show larger version as tooltip
*** allow adding or subtracting a number of days
*** add option to set the caption
** Pagination
*** turn the ~Page n of m~ text into a button to input a page number
**** clicking the button opens a dropdown with a text input field
**** pressing ~Enter~ or clicking ~Go~ button will dismiss dropdown and go to that page
** Database performance
*** search/edit should use Mango queries
**** search is slow because it is retrieving all of the records
**** should convert the input into a Mango query
**** however, Mango is for CouchDB exclusively, need a way for the repo to perform the scan
*** consider how record repository can implement sorting and pagination
**** objective would be to improve search performance if necessary
**** https://docs.couchdb.org/en/stable/ddocs/views/pagination.html
**** CoubhDB: use =skip= and =limit= parameters on view query
** Finding/removing duplicates
*** many assets are very similar to each other, probably differ only in metadata (HEIC->JPG conversion?)
*** find a means (histogram?) of detecting near-duplicates
** GraphQL landing page
*** eventually do away with the need for the landing page in production
**** will need to improve the web interface enough to offer everything that is needed
** Hosting externally
*** evaluate https://immich.app and what it has to offer
**** Q: how is it deployed?
**** Q: how does it store the images?
*** consider storage costs (currently under 100 GB)
*** place basic auth server in front (Azure app gateway maybe?)
*** consider deploying in read-only mode (sync would be tricky)
** Additional blob stores
*** any store that accomodates asset identifiers will work (S3-like)
*** thumbnails can be generated locally and cached if necessary
** Attribute management
*** search query to find assets that have no tags (>1,000)
*** search query to find assets that have no location (~2,000)
*** screen for showing all tags, locations, years, mediaTypes, with count values
**** selecting a tag or location offers a rename function
**** selecting multiple tags/locations offers option to remove from all assets
** Deleting assets
*** create graphql mutation to delete assets with certain tag
**** boolean argument ~yes~ to actually perform the delete
**** if ~yes~ is not truthy, reports what would be deleted
** Data Format Support
*** placeholder images for each media type
**** if a thumbnail cannot be produced, return a suitable placeholder for the main type (~image~, ~video~, etc)
*** read original date-time from MP4 videos
**** https://kevinnadro.com/blog/parsing-creation-time-from-mp4-metadata-in-javascript
*** PNG files apparently (can) have EXIF data, including orientation, check if this works
*** Read =ID3= tags in audio files
*** Detect time zone offset in EXIF data
According to Wikipedia the 2.31 version of EXIF will support time-zone
information. Eventually, the application should be able to detect this and
include it in the database records.

: There is no way to record time-zone information along with the time, thus
: rendering the stored time ambiguous. However, time-zone information have
: been introduced recently by Exif version 2.31 (July 2016). Related tags are:
: "OffsetTime", "OffsetTimeOriginal" and "OffsetTimeDigitized".

*** Render Markdown as HTML in a scrollable view
*** Display anything textual in a scrollable text area
*** HEIC/HEIF thumbnails, metadata
**** HEIF is an image file format employing HEVC (h.265) image coding
**** [[https://aomediacodec.github.io/av1-avif/][AV1]] is the free alternative to encumbered HEVC
**** https://github.com/catdad-experiments/libheif-js
**** https://github.com/catdad-experiments/heic-convert
**** https://github.com/catdad-experiments/heic-decode
*** read original date-time from RIFF/AVI files
**** easier to just convert them to MOV/MP4 using QuickTime player
**** RIFF/AVI code exists in Rust code =src/domain/usecases.rs=
** Machine learning
*** ML to identify objects, people, etc in photos
**** could use OpenCV for face recognition
**** evaluate how other tools make this easier
***** do they simply show the faces and have the user enter names?
**** ML recognizes the subject (dog, cat, person, etc)
**** PhotoPrism supports "automated tagging based on Google TensorFlow"
*** ML to rank photos on various qualities
**** c.f. https://simonwillison.net/2020/May/21/dogsheep-photos/
**** ML assigns scores on aesthetics, interest, etc
** Asset organization
*** Events
**** e.g. school performances, vacations
**** Means of assigning assets to a particular event
**** Browsing by events
*** Albums
**** i.e. organize assets by project, subject, event
**** Apple Photos has ~smart~ albums
***** assets taken around the same time, place
**** save search results as a new album
*** Groups and subgroups of assets
**** Turkey > Gallipoli Peninsula > Gali Winery
**** Winery > vinification > fermentation tanks
**** Architecture > Buildings > underground cellar
*** Find similar images based on their histograms(?)
*** Multiple libraries (like Apple Photos)
** Data Integrity
*** Add a GraphQL mutation that will delete and rebuild all indices
*** Guard against concurrent modifications
**** consider how to manage multiple users making changes
**** this is known as the ~lost update~ problem
**** usually managed with a revision number on the record
***** asset entity could contain a ~revision~ field (from CouchDB), updates would need to match that
***** updates must include the revision number; if mismatch, raise error
***** HTTP uses the =ETag= value and the =If-Match= header for this purpose
*** Find files for which there are no documents
*** Manage automated backups of the database
**** every M operations or T minutes/hours/days
**** retain N copies of the backup
**** use EXAF to backup the database
** Bulk Export
*** Easy selection and export of multiple images
** Easy publishing to sharing sites (e.g. Google Photos)
*** option to auto-orient
*** option to resize image
*** option to change format
*** option to strip metadata
*** option to apply watermarks
*** option to save in ePub format for iOS
*** button to open asset in file browser
** Easy import from external sites (e.g. google, instagram)
* Documentation
** Date/Time values
- Everything is treated as UTC
- EXIF data may contain timezone data depending on version
- [[http://www.unicode.org/reports/tr35/tr35-43/tr35-dates.html#Date_Format_Patterns][Date_Format_Patterns]]
* Resources
** File formats
*** Exif
**** c.f. https://www.cipa.jp/
** Location
*** c.f. https://github.com/google/open-location-code/wiki/Evaluation-of-Location-Encoding-Systems
*** c.f. https://www.osgeo.org for some information, resources
*** reverse geocoding services
**** Google requires using their maps and giving attribution(?)
**** Google and Azure can be quite expensive
**** many services have very low requests per second (~5)
**** HERE seems to be pretty good as of Feb 2024
**** list of providers found so far
- https://radar.com
- https://www.here.com/get-started/pricing
- https://developers.google.com/maps/documentation/geocoding/overview
- https://www.geoapify.com/reverse-geocoding-api
- https://docs.mapbox.com/api/search/geocoding/
- https://developer.apple.com/documentation/applemapsserverapi/reverse_geocode_a_location
- https://www.maptiler.com/cloud/geocoding/
- https://docs.aws.amazon.com/location/latest/developerguide/search-place-index-reverse-geocode.html
- https://learn.microsoft.com/en-us/rest/api/maps/search/get-search-address-reverse
